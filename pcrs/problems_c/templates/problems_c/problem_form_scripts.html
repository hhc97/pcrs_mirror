{% load staticfiles %}

{% load compress %}
{% compress js %}
<script src="{% static "codemirror-4.1/lib/codemirror_accessible.js" %}"
    type="text/javascript"></script>
<script src="{% static "codemirror-4.1/mode/clike/clike.js" %}"
    type="text/javascript"></script>
<script src="{% static "bootstrap_less/bootstrap-3.2.0/js/modal.js" %}"
    type="text/javascript"></script>
<script src="{% static "problems/js/TagManager.js" %}"
    type="text/javascript"></script>
<script src="{% static "problems/js/TabbedCodeMirror.js" %}"
    type="text/javascript"></script>
<script src="{% static "problems/js/AdminTabbedCodeMirror.js" %}"
    type="text/javascript"></script>
{# When another language is added modify code_mirror.js #}
<script src="{% static 'code_mirror.js' %}"
    type="text/javascript"></script>

<script type="text/javascript">
var cmh_list = {};
var language = 'c';
var language_version = 'text/x-csrc';
var id_starter_code_field = 'id_starter_code';
var id_solution_field = 'id_solution';

function submitHidden() {
    try {
        // NOTE: In the future, we may want to allow multiple files for C.
        var tcm = cmh_list[id_starter_code_field];
        var code = TagManager.addStudentCodeTags(tcm.getFiles()[0].code);
        var solutionCode = cmh_list[id_solution_field].getFiles()[0].code;

        // Move values to temporary variables
        document.getElementById("id_starter_code_tmp").value = code;
        document.getElementById("id_solution_tmp").value = solutionCode;
        return true;
    } catch (err) {
        alert('Error submitting code: ' + err.message);
        return false;
    }
}

function addTabbedCodeMirrorToFieldWithId(id, tcm) {
    var $element = $('#' + id);
    var code = $element.text();

    $element.replaceWith(tcm.getJQueryObject());

    tcm.setNewFileOptions({
        'mode': cmModeForLanguageAndVersion(language, language_version),
        'theme': user_theme,
    });

    var files = TagManager.parseCodeIntoFiles(code);
    for (var i = 0; i < files.length; i++) {
        tcm.addFile(files[i]);
    }
    tcm.setActiveTabIndex(0);

    cmh_list[id] = tcm;
}

function setupCodeMirrors() {
    addTabbedCodeMirrorToFieldWithId(id_starter_code_field,
        new AdminTabbedCodeMirror());
    addTabbedCodeMirrorToFieldWithId(id_solution_field,
        new TabbedCodeMirror());
}

$(function() {
    // Add function to submit button to update hidden field data
    $("#submit-id-clone").click(submitHidden);
    $("#submit-id-submit").click(submitHidden);
    $("#submit-id-attempt").click(submitHidden);

    // Add hidden values to submit code
    $('form').append('<input type="hidden" id="id_starter_code_tmp" ' +
                        'name="starter_code" value=""></input>' +
                    '<input type="hidden" id="id_solution_tmp" ' +
                        'name="solution" value=""></input>');

    setupCodeMirrors();
});
</script>
{% endcompress %}

{# Needed for AdminTabbedCodeMirror #}
{% include "problems/handlebars/icon_button.html" %}

